<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Students — School Panel | IIBSE</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    .wrap{max-width:1100px;margin:20px auto;padding:10px}
    .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .filters{display:flex;gap:8px;align-items:center}
    input.search{padding:8px 10px;border-radius:6px;border:1px solid #ccc;width:260px}
    select.filter{padding:8px;border-radius:6px;border:1px solid #ccc}
    .btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
    .btn-primary{background:#003b73;color:#fff}
    .btn-ghost{background:#f1f5fa;color:#003b73}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    th{background:#fafafa}
    .badge{padding:6px 8px;border-radius:6px;font-size:13px}
    .badge.pending{background:#fff3cd;color:#664d03}
    .badge.approved{background:#d4edda;color:#155724}
    .badge.rejected{background:#f8d7da;color:#721c24}
    .small{font-size:13px;color:#666}
    .actions button{margin-right:6px}
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:999}
    .modal .box{width:100%;max-width:820px;background:#fff;padding:18px;border-radius:8px}
    .field{margin-top:10px}
    .field label{display:block;font-weight:600;margin-bottom:6px}
    .field input, .field select, .field textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc}
    .row{display:flex;gap:10px}
    .col{flex:1}
  </style>
</head>
<body>

<header>
  <div class="logo">IIBSE Panel</div>
</header>

<div class="wrap">
  <div class="topbar">
    <div>
      <h2>Students</h2>
      <div class="small">Manage student applications, fees and certificates</div>
    </div>

    <div class="filters card" style="display:flex;align-items:center">
      <input id="searchInput" class="search" placeholder="Search by name, referral, cert no..." />
      <select id="filterType" class="filter">
        <option value="">All Admission Types</option>
        <option value="School">School</option>
        <option value="Skill">Skill</option>
        <option value="Diploma">Diploma</option>
      </select>
      <select id="filterStatus" class="filter">
        <option value="">All Status</option>
        <option value="Pending">Pending</option>
        <option value="Approved">Approved</option>
        <option value="Rejected">Rejected</option>
      </select>
      <select id="filterSession" class="filter">
        <option value="">All Sessions</option>
        <option value="2023-24">2023-24</option>
        <option value="2024-25">2024-25</option>
      </select>

      <button id="btnExport" class="btn btn-ghost">Export CSV</button>
      <button id="btnAddNew" class="btn btn-primary">Add New Student</button>
    </div>
  </div>

  <div class="card">
    <table id="studentsTable">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Class / Course</th>
          <th>Admission Type</th>
          <th>Referral ID</th>
          <th>Status</th>
          <th>Date</th>
          <th>Fees Pending</th>
          <th>Pay Now</th>
          <th>Action</th>
          <th>Certificate No.</th>
          <th>Session</th>
        </tr>
      </thead>
      <tbody id="studentsTbody"></tbody>
    </table>
  </div>
</div>

<!-- VIEW / EDIT MODAL -->
<div id="modalView" class="modal">
  <div class="box">
    <h3 id="viewTitle">View Student</h3>

    <form id="viewForm">
      <div class="row">
        <div class="col field">
          <label>Student Name</label>
          <input name="name" id="v_name" required />
        </div>
        <div class="col field">
          <label>Class / Course</label>
          <input name="classOrCourse" id="v_class" required />
        </div>
      </div>

      <div class="row">
        <div class="col field">
          <label>Admission Type</label>
          <select name="admissionType" id="v_type">
            <option>School</option><option>Skill</option><option>Diploma</option>
          </select>
        </div>
        <div class="col field">
          <label>Referral ID</label>
          <input name="referral" id="v_referral" />
        </div>
      </div>

      <div class="row">
        <div class="col field">
          <label>Status</label>
          <select name="status" id="v_status">
            <option>Pending</option><option>Approved</option><option>Rejected</option>
          </select>
        </div>
        <div class="col field">
          <label>Admission Date</label>
          <input type="date" name="date" id="v_date" />
        </div>
      </div>

      <div class="row">
        <div class="col field">
          <label>Fees Pending (₹)</label>
          <input type="number" name="feesPending" id="v_fees" min="0" />
        </div>
        <div class="col field">
          <label>Certificate No.</label>
          <input name="certificate" id="v_certificate" />
        </div>
      </div>

      <div class="row">
        <div class="col field">
          <label>Session</label>
          <input name="session" id="v_session" placeholder="e.g., 2024-25" />
        </div>
        <div class="col field">
          <label>Notes</label>
          <input name="notes" id="v_notes" />
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button type="button" id="btnSaveStudent" class="btn btn-primary">Save</button>
        <button type="button" id="btnCloseView" class="btn btn-ghost">Close</button>
      </div>
    </form>
  </div>
</div>

<!-- CONFIRM DELETE MODAL -->
<div id="modalDelete" class="modal">
  <div class="box">
    <h3>Delete Student</h3>
    <p>Are you sure you want to delete this student record? This action cannot be undone.</p>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="confirmDelete" class="btn btn-primary">Delete</button>
      <button id="cancelDelete" class="btn btn-ghost">Cancel</button>
    </div>
  </div>
</div>

<script src="../js/school-panel.js"></script>
<script>
/*
  school-students.html logic
  Uses localStorage 'iibse_school' (same demo data seeded by school-panel.js)
*/

function qs(sel){ return document.querySelector(sel) }
function fmtDate(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleDateString(); }

// Load and render students table
function loadStudents() {
  const raw = localStorage.getItem('iibse_school');
  if (!raw) { alert('No school data found. Please login via panel.'); window.location.href='school-login.html'; return; }
  const school = JSON.parse(raw);

  // search/filter values
  const q = qs('#searchInput').value.trim().toLowerCase();
  const typeFilter = qs('#filterType').value;
  const statusFilter = qs('#filterStatus').value;
  const sessionFilter = qs('#filterSession').value;

  const tbody = qs('#studentsTbody');
  tbody.innerHTML = '';

  // iterate students
  school.students.forEach((st, idx) => {
    // ensure fields exist
    st.feesPending = st.feesPending !== undefined ? st.feesPending : (st.fees || 0);
    st.admissionDate = st.admissionDate || st.date || st.createdAt || '';

    // filters
    if (typeFilter && st.admissionType !== typeFilter) return;
    if (statusFilter && st.status !== statusFilter) return;
    if (sessionFilter && (st.session || '') !== sessionFilter) return;

    // search across name, referral, certificate
    if (q) {
      const hay = ((st.name||'') + ' ' + (st.referral||'') + ' ' + (st.certificate||'')).toLowerCase();
      if (!hay.includes(q)) return;
    }

    const tr = document.createElement('tr');

    // Status badge
    let statusHtml = `<span class="badge ${st.status==='Approved'?'approved':st.status==='Rejected'?'rejected':'pending'}">${st.status||'Pending'}</span>`;

    tr.innerHTML = `
      <td>${escapeHtml(st.name || '')}</td>
      <td>${escapeHtml(st.classOrCourse || '')}</td>
      <td>${escapeHtml(st.admissionType || '')}</td>
      <td>${escapeHtml(st.referral || '')}</td>
      <td>${statusHtml}</td>
      <td>${fmtDate(st.admissionDate)}</td>
      <td>${st.feesPending && st.feesPending>0 ? '₹' + st.feesPending : '₹0'}</td>
      <td>${st.feesPending && st.feesPending>0 ? `<button class="btn btn-primary payBtn" data-idx="${idx}">Pay Now</button>` : ''}</td>
      <td class="actions">
        <button class="btn btn-ghost viewBtn" data-idx="${idx}">View</button>
        <button class="btn" style="background:#ffc107;color:#000" data-idx="${idx}" onclick="quickApprove(${idx})">Approve</button>
        <button class="btn" style="background:#dc3545;color:#fff" data-idx="${idx}" onclick="triggerDelete(${idx})">Delete</button>
      </td>
      <td>${escapeHtml(st.certificate || '')}</td>
      <td>${escapeHtml(st.session || '')}</td>
    `;

    tbody.appendChild(tr);
  });

  // wire up dynamic buttons
  qsa('.viewBtn').forEach(btn => btn.addEventListener('click', (e) => {
    const i = e.target.getAttribute('data-idx')*1;
    openViewModal(i);
  }));

  qsa('.payBtn').forEach(btn => btn.addEventListener('click', (e) => {
    const i = e.target.getAttribute('data-idx')*1;
    payNowForStudent(i);
  }));
}

// helper: returns array from querySelectorAll
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

// escape HTML to avoid XSS in demo
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m] }) }

// Open view/edit modal
let currentIndex = null;
function openViewModal(idx){
  const raw = JSON.parse(localStorage.getItem('iibse_school'));
  const st = raw.students[idx];
  currentIndex = idx;
  qs('#v_name').value = st.name||'';
  qs('#v_class').value = st.classOrCourse||'';
  qs('#v_type').value = st.admissionType||'School';
  qs('#v_referral').value = st.referral||'';
  qs('#v_status').value = st.status||'Pending';
  qs('#v_date').value = st.admissionDate ? new Date(st.admissionDate).toISOString().slice(0,10) : '';
  qs('#v_fees').value = st.feesPending || 0;
  qs('#v_certificate').value = st.certificate || '';
  qs('#v_session').value = st.session || '';
  qs('#v_notes').value = st.notes || '';
  qs('#modalView').style.display = 'flex';
}

// Save edited student
qs('#btnSaveStudent').addEventListener('click', ()=>{
  const raw = JSON.parse(localStorage.getItem('iibse_school'));
  if (currentIndex===null) return;
  const st = raw.students[currentIndex];
  st.name = qs('#v_name').value.trim();
  st.classOrCourse = qs('#v_class').value.trim();
  st.admissionType = qs('#v_type').value;
  st.referral = qs('#v_referral').value.trim();
  st.status = qs('#v_status').value;
  st.admissionDate = qs('#v_date').value ? qs('#v_date').value : st.admissionDate;
  st.feesPending = Number(qs('#v_fees').value||0);
  st.certificate = qs('#v_certificate').value.trim();
  st.session = qs('#v_session').value.trim();
  st.notes = qs('#v_notes').value.trim();
  localStorage.setItem('iibse_school', JSON.stringify(raw));
  qs('#modalView').style.display='none';
  loadStudents();
  alert('Student updated successfully.');
});

// Close view modal
qs('#btnCloseView').addEventListener('click', ()=>qs('#modalView').style.display='none');

// Delete flow
let deleteIndex = null;
function triggerDelete(idx){
  deleteIndex = idx;
  qs('#modalDelete').style.display = 'flex';
}
qs('#cancelDelete').addEventListener('click', ()=>{ deleteIndex=null; qs('#modalDelete').style.display='none'; });
qs('#confirmDelete').addEventListener('click', ()=>{
  if (deleteIndex===null) return;
  const raw = JSON.parse(localStorage.getItem('iibse_school'));
  raw.students.splice(deleteIndex,1);
  localStorage.setItem('iibse_school', JSON.stringify(raw));
  deleteIndex = null;
  qs('#modalDelete').style.display='none';
  loadStudents();
  alert('Student deleted.');
});

// Quick Approve button (for speed)
function quickApprove(idx){
  const raw = JSON.parse(localStorage.getItem('iibse_school'));
  raw.students[idx].status = 'Approved';
  // optionally generate a certificate number
  if(!raw.students[idx].certificate) raw.students[idx].certificate = 'IIBSE' + Date.now();
  localStorage.setItem('iibse_school', JSON.stringify(raw));
  loadStudents();
  alert('Student approved and certificate generated (demo).');
}

// Pay Now (student-level) - demo payment flow
function payNowForStudent(idx){
  const raw = JSON.parse(localStorage.getItem('iibse_school'));
  const st = raw.students[idx];
  if (!st.feesPending || st.feesPending <= 0) { alert('No pending fees for this student.'); return; }
  const ok = confirm(`Pay ₹${st.feesPending} for ${st.name}? Proceed (demo)?`);
  if (!ok) return;
  // demo: mark fees as paid
  st.feesPending = 0;
  // save as payment record (optional)
  raw.students[idx] = st;
  if(!raw.payments) raw.payments = [];
  raw.payments.push({studentName: st.name, amount: Number(st.feesPending||0), date: new Date().toISOString()});
  localStorage.setItem('iibse_school', JSON.stringify(raw));
  loadStudents();
  alert('Payment successful (demo).');
}

// Export CSV
function exportCSV(){
  const raw = JSON.parse(localStorage.getItem('iibse_school'));
  if(!raw || !raw.students || raw.students.length===0){ alert('No students to export'); return; }
  const rows = [];
  const header = ['Student Name','Class/Course','Admission Type','Referral ID','Status','Date','Fees Pending','Certificate No.','Session','Notes'];
  rows.push(header.join(','));
  raw.students.forEach(st=>{
    const r = [
      `"${(st.name||'').replace(/"/g,'""')}"`,
      `"${(st.classOrCourse||'').replace(/"/g,'""')}"`,
      `"${(st.admissionType||'').replace(/"/g,'""')}"`,
      `"${(st.referral||'').replace(/"/g,'""')}"`,
      `"${(st.status||'').replace(/"/g,'""')}"`,
      `"${(st.admissionDate||'').replace(/"/g,'""')}"`,
      `"${(st.feesPending||0)}"`,
      `"${(st.certificate||'').replace(/"/g,'""')}"`,
      `"${(st.session||'').replace(/"/g,'""')}"`,
      `"${(st.notes||'').replace(/"/g,'""')}"`,
    ];
    rows.push(r.join(','));
  });
  const csv = rows.join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'iibse_students_export.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// Add New Student button -> opens admission modal (existing dashboard logic)
// We'll redirect to panel/school-admissions.html (your form) or open admission modal if exists
qs('#btnAddNew').addEventListener('click', ()=> {
  // if admissions page exists, open it
  window.location.href = 'school-admissions.html';
});

// Filters and search wiring
qs('#searchInput').addEventListener('input', loadStudents);
qs('#filterType').addEventListener('change', loadStudents);
qs('#filterStatus').addEventListener('change', loadStudents);
qs('#filterSession').addEventListener('change', loadStudents);
qs('#btnExport').addEventListener('click', exportCSV);

// on page load
(function init(){
  // ensure demo data exists
  if (!localStorage.getItem('iibse_school')) {
    // fallback: create demo (same seed used by school-panel.js)
    const demo = {
      id: "SCH001",
      name: "Demo Skill Academy",
      category: "training_center",
      approvedModules: ["foundational","preparatory"],
      pendingFees: [{type:"Affiliation Annual",amount:1200}],
      students: [
        { name:"Asha Kumar", classOrCourse:"Grade 1", admissionType:"School", referral:"ADV001", status:"Pending", admissionDate: new Date().toISOString(), feesPending:0, certificate:"", session:"2024-25"},
        { name:"Vikram Rao", classOrCourse:"Diploma in DMLT", admissionType:"Diploma", referral:"", status:"Pending", admissionDate: new Date().toISOString(), feesPending:1500, certificate:"", session:"2024-25"},
        { name:"Suman Patel", classOrCourse:"Grade 4", admissionType:"School", referral:"ADV002", status:"Approved", admissionDate: new Date().toISOString(), feesPending:0, certificate:"IIBSE12345", session:"2023-24"},
      ],
      moduleRequests: []
    };
    localStorage.setItem('iibse_school', JSON.stringify(demo));
  }

  // ensure logged-in demo redirect same behavior as other panel pages
  // if user not logged in (no demo), redirect to login page
  // school-panel.js seedDemo would have set it earlier on login; we keep fallback above.

  loadStudents();
})();
</script>
</body>
</html>
